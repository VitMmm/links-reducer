<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reducer link</title>
    <script>
      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ö–µ—à–∞ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ —Ä–µ–Ω–¥–µ—Ä–∞)
      (function () {
        if (window.location.hash && window.location.hash.length > 1) {
          // –°–∫—Ä—ã–≤–∞–µ–º body —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–µ–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É
          document.documentElement.style.display = 'none';
          // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ
          const hash = window.location.hash.substring(1);
          fetch(window.location.origin + '/api/links/' + hash)
            .then((response) => response.json())
            .then((data) => {
              if (data.longUrl) {
                window.location.replace(data.longUrl);
              } else {
                // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                document.documentElement.style.display = '';
              }
            })
            .catch(() => {
              // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
              document.documentElement.style.display = '';
            });
        }
      })();
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: #ffffff;
        color: #1a1a1a;
        padding: 40px 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 40px;
      }

      .header-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .header-icon::before {
        content: 'üåê';
        font-size: 20px;
      }

      .header-title {
        font-size: 24px;
        font-weight: 600;
        color: #1a1a1a;
      }

      .form-section {
        margin-bottom: 32px;
      }

      .label-container {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
      }

      .label {
        font-size: 14px;
        font-weight: 500;
        color: #1a1a1a;
      }

      .info-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1.5px solid #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #6b7280;
        cursor: help;
        flex-shrink: 0;
      }

      .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #1a1a1a;
        background-color: #ffffff;
        transition: border-color 0.2s;
      }

      .input-field:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .input-field::placeholder {
        color: #9ca3af;
      }

      .two-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
      }

      .select-wrapper {
        position: relative;
      }

      .select-field {
        width: 100%;
        padding: 12px 16px;
        padding-right: 40px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #1a1a1a;
        background-color: #ffffff;
        appearance: none;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .select-field:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .select-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 6px solid #6b7280;
        pointer-events: none;
      }

      .input-with-button {
        display: flex;
        gap: 0;
      }

      .input-with-button .input-field {
        border-radius: 8px 0 0 8px;
        border-right: none;
        flex: 1;
      }

      .optimize-button {
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-left: none;
        border-radius: 0 8px 8px 0;
        background-color: #ffffff;
        color: #1a1a1a;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background-color 0.2s;
        white-space: nowrap;
      }

      .optimize-button:hover {
        background-color: #f9fafb;
      }

      .optimize-button::after {
        content: '‚ñº';
        font-size: 10px;
        color: #6b7280;
      }

      .hint {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 12px;
        color: #6b7280;
      }

      .hint-arrow {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
      }

      .hint-left {
        transform: rotate(-45deg);
      }

      .hint-right {
        transform: rotate(45deg);
      }

      .submit-button {
        width: 100%;
        padding: 14px 24px;
        background-color: #3b82f6;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 8px;
      }

      .submit-button:hover {
        background-color: #2563eb;
      }

      .submit-button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }

      .result-section {
        margin-top: 32px;
        padding: 24px;
        background-color: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        display: none;
      }

      .result-section.show {
        display: block;
      }

      .result-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .result-link-container {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .result-link {
        flex: 1;
        padding: 12px 16px;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 16px;
        color: #1a1a1a;
        font-family: 'Courier New', monospace;
        word-break: break-all;
      }

      .copy-button {
        padding: 12px 20px;
        background-color: #10b981;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        white-space: nowrap;
      }

      .copy-button:hover {
        background-color: #059669;
      }

      .copy-button.copied {
        background-color: #6b7280;
      }

      .error-message {
        margin-top: 8px;
        padding: 12px;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        color: #dc2626;
        font-size: 14px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      @media (max-width: 768px) {
        .two-columns {
          grid-template-columns: 1fr;
        }

        .result-link-container {
          flex-direction: column;
        }

        .copy-button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-icon"></div>
        <h1 class="header-title">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ñ–∏—Ä–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –∏ QR-–∫–æ–¥.</h1>
      </div>

      <div class="form-section">
        <div class="label-container">
          <label class="label" for="destination-url">–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏–Ω–Ω—É—é —Å—Å—ã–ª–∫—É</label>
          <div class="info-icon" title="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å">i</div>
        </div>
        <input type="url" id="destination-url" class="input-field" placeholder="https://example.com/very/long/url/with/many/parameters" />
        <div class="error-message" id="error-message"></div>
      </div>

      <div class="form-section">
        <div class="label-container">
          <label class="label" for="custom-slug">–°—É—Ñ—Ñ–∏–∫—Å –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏</label>
          <div class="info-icon" title="–£–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Å—É—Ñ—Ñ–∏–∫—Å –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">i</div>
        </div>
        <input type="text" id="custom-slug" class="input-field" placeholder="my-custom-link (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)" />
        <button type="button" id="submit-button" class="submit-button">–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É</button>
      </div>
      
      <!-- –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è Open Graph -->
      <div class="form-section" id="image-upload-section" style="margin-top: 8px;">
        <div class="label-container">
          <label class="label" for="og-image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–≤—å—é (Open Graph)</label>
          <div class="info-icon" title="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø—Ä–µ–≤—å—é –ø—Ä–∏ —à–∞—Ä–∏–Ω–≥–µ">i</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <input type="file" id="og-image" accept="image/*" />
          <button type="button" id="remove-image-button" style="display:none;padding:8px 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div id="og-image-preview" style="margin-top:12px;display:none;">
          <img id="og-preview-img" src="" alt="preview" style="max-width:200px;max-height:120px;border-radius:8px;border:1px solid #e5e7eb;" />
        </div>
      </div>

      <div class="result-section" id="result-section">
        <div class="result-label">–í–∞—à–∞ –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞:</div>
        <div class="result-link-container">
          <div class="result-link" id="result-link"></div>
          <button type="button" class="copy-button" id="copy-button">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <script>
      // API –±–∞–∑–æ–≤—ã–π URL
      // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π backend, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ —É–∫–∞–∂–∏—Ç–µ URL:
      // const API_BASE_URL = 'https://your-backend.railway.app';
      // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º)
      const API_BASE_URL = window.location.origin;

      // –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ API (–¥–æ–±–∞–≤–ª–µ–Ω–æ imageUrl –¥–ª—è OG)
      async function createLink(longUrl, slug, imageUrl) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/links`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              longUrl: longUrl,
              slug: slug || null,
              imageUrl: imageUrl || null,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏');
          }

          return data;
        } catch (error) {
          throw error;
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –æ–∂–∏–¥–∞–µ—Ç—Å—è endpoint POST /api/uploads, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π { url }
      async function uploadImage(file) {
        if (!file) return null;
        try {
          const form = new FormData();
          form.append('file', file);

          const resp = await fetch(`${API_BASE_URL}/api/uploads`, {
            method: 'POST',
            body: form,
          });

          const payload = await resp.json();
          if (!resp.ok) {
            throw new Error(payload.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          }

          return payload.url || null;
        } catch (err) {
          throw err;
        }
      }

      // –ü–æ–ª—É—á–∏—Ç—å –¥–ª–∏–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –ø–æ slug —á–µ—Ä–µ–∑ API
      async function getLinkBySlug(slug) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/links/${slug}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || '–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          }

          return data.longUrl;
        } catch (error) {
          throw error;
        }
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è URL (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã —Ç–∏–ø–∞ {{ad.id}})
      function isValidUrl(string) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É URL
        const urlPattern = /^https?:\/\/.+/i;
        if (!urlPattern.test(string)) {
          return false;
        }

        // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å URL, –∑–∞–º–µ–Ω—è—è —à–∞–±–ª–æ–Ω—ã –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        try {
          const testUrl = string.replace(/\{\{[^}]+\}\}/g, 'test');
          const url = new URL(testUrl);
          return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (_) {
          // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ö–æ—Ç—è –±—ã –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          return urlPattern.test(string);
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
      function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.textContent = message;
        errorEl.classList.add('show');
      }

      // –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫—É
      function hideError() {
        const errorEl = document.getElementById('error-message');
        errorEl.classList.remove('show');
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      function showResult(shortUrl) {
        const resultSection = document.getElementById('result-section');
        const resultLink = document.getElementById('result-link');
        resultLink.textContent = shortUrl;
        resultSection.classList.add('show');
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          const copyButton = document.getElementById('copy-button');
          const originalText = copyButton.textContent;
          copyButton.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
          copyButton.classList.add('copied');

          setTimeout(() => {
            copyButton.textContent = originalText;
            copyButton.classList.remove('copied');
          }, 2000);
        } catch (err) {
          // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);

          const copyButton = document.getElementById('copy-button');
          copyButton.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
          setTimeout(() => {
            copyButton.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
          }, 2000);
        }
      }

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è slug (—É–±–∏—Ä–∞–µ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã)
      function normalizeSlug(slug) {
        if (!slug) return '';
        // –£–±–∏—Ä–∞–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã
        return slug
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9-]/g, '')
          .replace(/-+/g, '-');
      }

      // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ —Å –¥–æ–º–µ–Ω–æ–º —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–±–µ–∑ –ø—É—Ç–∏)
      function formatShortUrl(slug) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–º–µ–Ω (origin) –±–µ–∑ –ø—É—Ç–∏
        // –ù–∞–ø—Ä–∏–º–µ—Ä: https://claimordernow.store –≤–º–µ—Å—Ç–æ https://claimordernow.store/landings/sweeps/_TEST/re_links
        return window.location.origin + '/' + slug;
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–∏ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è OG)
      document.getElementById('submit-button').addEventListener('click', async function () {
        const input = document.getElementById('destination-url');
        const slugInput = document.getElementById('custom-slug');
        const submitButton = document.getElementById('submit-button');
        const fileInput = document.getElementById('og-image');
        const longUrl = input.value.trim();
        const customSlug = slugInput.value.trim();

        hideError();

        if (!longUrl) {
          showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
          return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        let processedUrl = longUrl;
        if (!longUrl.startsWith('http://') && !longUrl.startsWith('https://')) {
          processedUrl = 'https://' + longUrl;
        }

        if (!isValidUrl(processedUrl)) {
          showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å http:// –∏–ª–∏ https://)');
          return;
        }

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º slug, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        let normalizedSlug = null;
        if (customSlug) {
          normalizedSlug = normalizeSlug(customSlug);
          if (!normalizedSlug) {
            showError('–°—É—Ñ—Ñ–∏–∫—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã');
            return;
          }
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
        submitButton.disabled = true;
        submitButton.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
          // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∏ –ø–æ–ª—É—á–∞–µ–º imageUrl
          let imageUrl = null;
          try {
            const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
            if (file) {
              imageUrl = await uploadImage(file);
            }
          } catch (uploadErr) {
            // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', uploadErr);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –°—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑ –ø—Ä–µ–≤—å—é.');
          }

          // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É, –ø–µ—Ä–µ–¥–∞–≤–∞—è imageUrl –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          const result = await createLink(processedUrl, normalizedSlug, imageUrl);

          // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É
          const shortUrl = formatShortUrl(result.slug);

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          showResult(shortUrl);

          // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –µ—Å–ª–∏ backend –≤–µ—Ä–Ω—É–ª imageUrl –∏–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å imageUrl
          const previewUrl = result.imageUrl || imageUrl || null;
          if (previewUrl) {
            const previewWrap = document.getElementById('og-image-preview');
            const previewImg = document.getElementById('og-preview-img');
            previewImg.src = previewUrl;
            previewWrap.style.display = 'block';
          }
        } catch (error) {
          showError(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏');
        } finally {
          // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
          submitButton.disabled = false;
          submitButton.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É';
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      document.getElementById('copy-button').addEventListener('click', function () {
        const resultLink = document.getElementById('result-link');
        copyToClipboard(resultLink.textContent);
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
      document.getElementById('destination-url').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('submit-button').click();
        }
      });

      document.getElementById('custom-slug').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('submit-button').click();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –∏ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
      const ogInput = document.getElementById('og-image');
      const removeBtn = document.getElementById('remove-image-button');
      const previewWrap = document.getElementById('og-image-preview');
      const previewImg = document.getElementById('og-preview-img');

      if (ogInput) {
        ogInput.addEventListener('change', function () {
          const file = ogInput.files && ogInput.files[0] ? ogInput.files[0] : null;
          if (file) {
            const url = URL.createObjectURL(file);
            previewImg.src = url;
            previewWrap.style.display = 'block';
            removeBtn.style.display = 'inline-block';
          } else {
            previewImg.src = '';
            previewWrap.style.display = 'none';
            removeBtn.style.display = 'none';
          }
        });
      }

      if (removeBtn) {
        removeBtn.addEventListener('click', function () {
          if (ogInput) {
            ogInput.value = '';
          }
          previewImg.src = '';
          previewWrap.style.display = 'none';
          removeBtn.style.display = 'none';
        });
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ö–µ—à–∞ –≤ URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ (fallback, –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤ head –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
      (async function () {
        const hash = window.location.hash.substring(1);
        if (hash) {
          try {
            // –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏–Ω–Ω—É—é —Å—Å—ã–ª–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞
            const longUrl = await getLinkBySlug(hash);
            if (longUrl) {
              // –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
              window.location.replace(longUrl);
              return;
            }
          } catch (error) {
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É (–æ–Ω–∞ –º–æ–≥–ª–∞ –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞ —Å–∫—Ä–∏–ø—Ç–æ–º –≤ head)
            document.documentElement.style.display = '';
            console.error('–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', error);
          }
        }
      })();
    </script>
  </body>
</html>
